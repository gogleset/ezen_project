<!--
 * @filename  : order_confirm.html
 * @author    : 정한슬 (seul5106@gmail.com)
 * @description : 주문확인(결제완료) html
 * 
 * 
 -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
    <title>Document</title>
    <!-- 웹폰트(한글) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <!-- 폰트어썸 -->
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <!-- 구글 마테리얼 아이콘 -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- sweetalert-->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- CSS 참조 파일 -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/headerfooter.css">
    <link rel="stylesheet" href="../css/cart.css">
    <link rel="stylesheet" href="../css/order_confirm.css">
</head>

<body>
    <!-- 전체 콘테이너입니다 -->
    <div class="container">
        <!-- 상단 헤더를 표시합니다 -->
        <div data-init="./inc/header.html"></div>
        <!-- 내용부분입니다. -->
        <section class="content">
            <!-- 내용 안쪽부분입니다. -->
            <div class="inner-content min-height">
                <!-- 제목부분입니다. -->
                <h1 class="cart-title title">결제완료된 주문입니다.</h1>
                <!-- 제목 안쪽 미결제 항목부분입니다. -->
                <div class="cart-sub-title">
                    <span class="unpaid-count">상품 정보 확인</span>
                </div>

                <!-- 장바구니 목록을 카운트합니다. -->
                <div class="box-cart-content">

                </div>

                <div class="delivery-confirm">
                    <h2>배송 정보 확인</h2>
                    <hr>
                    <div class="delivery-info-name">
                        <div class="delivery-form">
                            <span class="text-indent">주문자 전화번호:</span>
                            <span id="orderer_phone" class="flex-grow">000-0000-0000</span>
                        </div>
                        <div class="delivery-form">
                            <span class="text-indent">주문자 이름:</span>
                            <span id="orderer_name" class="flex-grow">홍길동</span>
                        </div>
                        <div class="delivery-form">
                            <span class="text-indent">주문자 주소:</span>
                            <span id="orderer_addr" class="flex-grow">서울 특별시 00구 00동 00번지 000아파트 000동 000호</span>
                        </div>
                        <div class="delivery-form">
                            <span class="text-indent">주문자 이메일 주소:</span>
                            <span id="orderer_email" class="flex-grow">ezen@gmail.com</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 결제 합계 부분입니다. -->
            <div class="box-cart-total">
                <h2>결제 합계</h2>
                <hr>
                <!-- 갯수 박스들 입니다. -->
                <div class="box-total">
                    <span class="prod-total">전체 상품 개수</span>
                    <span class="prod-total-number pull-right">0개</span>
                </div>
                <hr>
                <div class="box-total">
                    <span class="money-total">상품 금액</span>
                    <span class="money-total-number pull-right">0원</span>
                </div>
                <hr>
                <div class="box-total">
                    <span class="paid-money">결제 금액</span>
                    <span class="paid-money-number pull-right">0원</span>
                </div>
                <hr style="margin-bottom: 0;">
            </div>
        </section>

        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="./assets/layout.js"></script>

        <script>
            const url = new URL(window.location.href);
            const urlParams = url.searchParams;
            const merchant_uid = urlParams.get('merchant_uid');
            const imp_uid = urlParams.get('imp_uid');
            const imp_success = urlParams.get('imp_success');

            const mer = urlParams.get('mer');


            //URL에 변수값이 존재하는걸로 실행 방식을 나눈다(메뉴에서 주문내역확인 페이지진입 or 결제후 주문내역확인 페이지 진입을 위해)
            if (imp_success) {
                //http://192.168.55.95:3217/html/order_confirm.html?imp_uid=imp_807998726697&merchant_uid=merchant_1645608980100&imp_success=true
                let json1 = null;
                let json2 = null;
                //결제페이지에서 결재 후 주문확인페이지로 넘어갔을경우
                //결제결과가 false면 결제페이지로 돌아간다.
                if (imp_success == false) {
                    location.href("payment.html");
                }


                (async () => {
                    try {
                        const response = await axios.post(`/order_confirm`, {
                            merchant_uid: merchant_uid,
                            imp_uid: imp_uid
                        })
                        json1 = response.data.item1;
                        [json2] = response.data.item2;
                    } catch (e) {
                        console.log(e)
                    }

                    console.log(json2)

                    console.log(json2.receiver_phone);
                    //배송 정보 확인
                    document.getElementById("orderer_phone").innerHTML = json2.receiver_phone;
                    document.getElementById("orderer_name").innerHTML = json2.receiver_name;
                    document.getElementById("orderer_addr").innerHTML = json2.receiver_addr1 + " " + json2.receiver_addr2 + " " + json2.receiver_addr3;
                    document.getElementById("orderer_email").innerHTML = json2.receiver_email;

                    json1.map((v) => {
                        console.log(v);
                        let BoxCart = document.querySelector('.box-cart-content')
                        BoxCart.innerHTML += `<div class="box-cart div-center clearfix"><a href="#">
                                  <img class="pull-left" src="${v.ordered_product_img}" alt="#">
                              </a>
                              <div class="box-cart-inner pull-right">
                                  <span class="box-cart-prod-name">${v.ordered_product_name}</span>
                                  <span class="box-cart-money pull-right">${v.ordered_product_price}원</span>
                                  <span class="cart-count">${v.ordered_product_count}개</span>
                              </div></div>`
                    })
                    startPayment()
                })()

            } else {
                //메뉴에서 주문내역을 거쳐 주문확인페이지로 넘어갔을경우

                let json1 = null;
                let json2 = null;

                (async () => {
                    try {
                        //post로 merchant_uid넘겨줘야됨
                        const response = await axios.post(`/menu_ordered`, {
                            merchant_uid: mer
                        })
                        json1 = response.data.item1;
                        [json2] = response.data.item2;
                    } catch (e) {
                        console.log(e)
                    }

                    console.log(json1);
                    // Y = 주문완료, N = 주문실패, D = 결제 대기
                    if (json2.order_state == "N") {
                        document.querySelector(".cart-title").innerHTML = "취소된 주문입니다."
                    }
                    //배송 정보 확인
                    document.getElementById("orderer_phone").innerHTML = json2.receiver_phone;
                    document.getElementById("orderer_name").innerHTML = json2.receiver_name;
                    document.getElementById("orderer_addr").innerHTML = json2.receiver_addr1 + " " + json2.receiver_addr2 + " " + json2.receiver_addr3;
                    document.getElementById("orderer_email").innerHTML = json2.receiver_email;

                    json1.map((v) => {

                        console.log(v);
                        let BoxCart = document.querySelector('.box-cart-content')
                        BoxCart.innerHTML += `
                            <div class="box-cart div-center clearfix">
                                <a href="#">
                                    <img class="pull-left" src="${v.ordered_product_img}" alt="#">
                                </a>
                                <div class="box-cart-inner pull-right">
                                    <span class="box-cart-prod-name">${v.ordered_product_name}</span>
                                    <span class="box-cart-money pull-right">${v.ordered_product_price}원</span>
                                    <span class="cart-count">${v.ordered_product_count}개</span>
                                </div>
                            </div>`
                    })
                    startPayment()
                })()
            }

            function startPayment() {
                // box-cart가 있는지 없는지 감지하는 변수입니다.
                let content = document.querySelector(".inner-content .box-cart");
                // // 상품 목록 박스입니다.
                let boxMoney = document.querySelectorAll(".box-cart-money");
                // // 상품 갯수 입니다.
                let countProdNum = document.querySelectorAll(".cart-count");
                // 상품의 가격입니다.
                let cartMoney = document.querySelectorAll(".box-cart-money");
                // // 상품의 총 갯수입니다.
                let count = 0;
                // // 상품의 총 금액입니다.
                let money = 0;
                // 상품 갯수가 들어있는 배열입니다.
                let countArray = [];
                // 상품 가격이 들어있는 배열입니다.
                let moneyArray = [];

                // 상품목록이 있다면
                if (content != null) {
                    // box-cart-content의 자식 갯수를 파악합니다.
                    let contentCount = document.querySelector(".box-cart-content").childElementCount;
                    // console.log(contentCount);

                    // // 상품 금액입니다.
                    let cartMoney = document.querySelectorAll(".box-cart-money");
                    // // 총 합산한 금액입니다.
                    let totalMoney = document.querySelector(".money-total-number");
                    // // 총 결제할 금액입니다.
                    let payMoney = document.querySelector(".paid-money-number");
                    // // 총 전체 상품 개수 입니다.
                    let totalProdNum = document.querySelector(".prod-total-number");
                    // // 총 전체 상품 이름.
                    let totalName = document.querySelector("box-cart-prod-name");

                    const result = () => {
                        countArray = [];
                        moneyArray = [];
                        count = 0;
                        money = 0;

                        // 상품갯수을 재할당하여 초기화 합니다.
                        countProdNum = document.querySelectorAll(".cart-count");
                        // 상품의 갯수를 배열에 넣습니다.
                        countProdNum.forEach((v) => {
                            countArray.push(parseInt(v.innerHTML));
                        })
                        // 상품가격을 재할당하여 초기화 합니다.
                        boxMoney = document.querySelectorAll(".box-cart-money");
                        // 상품의 가격을 배열에 넣습니다.
                        boxMoney.forEach((v) => {
                            moneyArray.push(parseInt(v.innerHTML));
                        })

                        // 전체상품의 총 갯수는
                        countArray.forEach((v) => {
                            count += v
                        })
                        console.log(count);
                        // 전체상품의 총 가격은
                        moneyArray.forEach((v, i) => {
                            money += moneyArray[i] * countArray[i]
                        })
                        console.log(money);
                        // 장바구니 합계에 출력됩니다.
                        totalProdNum.innerHTML = count + "개";
                        totalMoney.innerHTML = money + "원";
                        payMoney.innerHTML = parseInt(money + (money / 100)) + "원";
                        // 서버로 보낼 가격입니다.
                    }
                    result();
                }
            }





        </script>
</body>

</html>